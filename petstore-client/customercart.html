<!DOCTYPE html>
<html lang="en">

<head>
  <title>CIST2931 PetStore</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- CSS only -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
        integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">

  <!-- JS, Popper.js, and jQuery -->
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
          integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj"
          crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
          integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN"
          crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"
          integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV"
          crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.0/css/all.css"
        integrity="sha384-lZN37f5QGtY3VHgisS14W3ExzMWZxybE1SJSEsQp9S+oqd12jhcu+A56Ebc1zFSJ" crossorigin="anonymous">
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="stylesheet" href="./css/style.css">
  <script src="js/api.js"></script>
  <script src="js/objects.js"></script>

  <script>
      let cartItems = new Map();
      let merchInfos = new Map();

      /**
       * Action flow
       * 1. load cart from local storage if available - done
       * 2. add item from parameters if available - done
       * 3. if we have items, send merchInfoRequest for each.
       * 4. once all merchInfoRequests have returned, fill cart DOM
       */

      function onLoad() {
          setClientAccountStatus();
          if (localStorage.getItem('first_name') !== null) {
              const customerName = `${localStorage.getItem("first_name")} ${localStorage.getItem("last_name")}`;
              document.getElementById("hello").innerHTML = `Hello ${customerName}!`;
              document.getElementById("customer_name").innerHTML = customerName;
              document.getElementById("street_address").innerHTML = localStorage.getItem("street");
              document.getElementById("city_state").innerHTML =
                  `${localStorage.getItem("city")} ${localStorage.getItem("state")} ${localStorage.getItem("zip")}`;


              // load cart from localstorage
              loadCart();

              // check if adding item
              const queryString = window.location.search;
              if (queryString.length) {
                  const params = new URLSearchParams(queryString);

                  if (params.has('addItem')) {
                      let merchID = Number.parseInt(params.get('addItem'));
                      let quantity = params.has('quantity') ? Number.parseInt(params.get('quantity')) : 1;

                      let newCartItem = new CartItem(merchID, quantity);

                      if (cartItems.length === 0) {
                          cartItems.push(newCartItem);
                      } else {
                          for (let i = 0; i < cartItems.length; i++) {
                              let existingItem = cartItems[i];

                              if (existingItem.merchID === newCartItem.merchID) {
                                  existingItem.quantity += newCartItem.quantity;
                              } else {
                                  cartItems.push(newCartItem);
                              }
                          }
                      }
                      saveCart();
                  }
              }

              if (cartItems.length !== 0) {
                  // begin requesting merch info
                  for(let item of cartItems) {
                      const reqURI = `/api/v1/merchandise/${item.merchID}`;
                      sendRequest(reqURI, 'GET', null, onMerchInfoSuccess);
                  }
              } else {
                  document.getElementById('cart_title').innerText = 'You have no items in your cart.';
              }
          } else {
              // redirect users to login if not already logged in
              document.location.assign("login.html");
          }
      }

      function onMerchInfoSuccess() {
          const xhrResponse = this;
          const merchID = xhrResponse.responseURL.match(/\d+$/)[0];

          if (xhrResponse.status === 200) {
              let jsonObj = JSON.parse(xhrResponse.responseText);
              let merchInfo = Merchandise.FromJsonObject(jsonObj);
              merchInfos.set(Number.parseInt(merchID), merchInfo);
              console.debug(`Got merch info for ID: ${merchID}`);
          } else if (xhrResponse.status === 404) {
              generalError(`Failed to find merchandise with ID: ${merchID}`);
          }

          if (merchInfos.size === cartItems.length) {
              console.debug('Got all merch infos');
              displayCartItems();
          }
      }

      // fill the DOM with the cart info
      function displayCartItems() {
          let merchHtml = ``;
          let cartTotal = 0;

          if (cartItems.length === 0) {
              document.getElementById('cart_subtotal').innerHTML = '';
              return;
          }

          let i = 0;
          for (let i = 0; i < cartItems.length; i++) {
              let cartItem = cartItems[i];
              let merchInfo = merchInfos.get(cartItem.merchID);


              if (!merchInfo) {
                  console.error("Failed to get info for single item!" + cartItem.merchID);
                  continue;
              }

              // make sure they can't add more than available quantity of items
              if (cartItem.quantity > merchInfo.quantity) cartItem.quantity = merchInfo.quantity;

              let itemTotal = cartItem.quantity * merchInfo.price;
              cartTotal += itemTotal;

              let itemTotalPretty = `$${(itemTotal).toFixed(2)}`;

              console.log(`CartItem ${i} - ID: ${cartItem.merchID}, Quantity: ${cartItem.quantity}`);
              console.log(`CartItemInfo ${i} - Name: ${merchInfo.merchName}, Price: ${merchInfo.prettyPrice}, OnHand: ${merchInfo.quantity}`);

              // create quantity selector
              let quantityHtml = `<select class="form-control" id="sel${i + 1}" onchange="updateCartQuantity(this, ${cartItem.merchID})">`;

              // add available quantity
              for (let q = 0; q < merchInfo.quantity; q++) {
                  const quantity = q + 1;

                  quantityHtml += `<option value="${quantity}"`;
                  if (cartItem.quantity === quantity) quantityHtml += ` selected`;
                  quantityHtml += `>${quantity}</option>`;
              }

              quantityHtml += `</select>`;

              let itemHtml =
                  `
                  <table class="table table__table">
                    <tbody>
                      <tr>
                        <td class="align-middle td_first">
                          <div>
                            <img class="img img-fluid" src="./img/${merchInfo.imageFileName}" alt="Product image" style="padding:15px;">
                          </div>
                        </td>
                        <td class="align-middle td_second">
                          <div class="text-center">
                            <h5 class="card-custom__title">${merchInfo.merchName}</h5>
                            <p class="card-text">${merchInfo.prettyPrice}</p>
                          </div>
                        </td>
                        <td class="align-middle td_third">
                          <div class="form-group select">
                            ${quantityHtml}
                          </div>
                          <div>
                            <p class="card-text">${itemTotalPretty}</p>
                          </div>
                        </td>
                        <td class="align-middle text-center td_forth">
                          <a href="#" onclick="deleteCartItem(${cartItem.merchID})"><p style="margin:0 auto;">
                            <i class=" material-icons" style="vertical-align: middle;">&#xe928;</i> Delete
                          </p></a>
                        </td>
                      </tr>
                    </tbody>
                  </table>
                  `

              merchHtml += itemHtml;
          }

          let prettyCartTotal = `$${(cartTotal).toFixed(2)}`

          document.getElementById('cart_title').innerText = 'Review items in your cart:';
          document.getElementById('cart_container').innerHTML = merchHtml;
          document.getElementById('cart_subtotal').innerHTML =
              `
                  <div class="left-item">
                    <h5>Subtotal:</h5>
                  </div>
                  <div class="right-item">
                    <h5 id="subtotal">${prettyCartTotal}</h5>
                  </div>
                  `
      }

      function loadCart() {
          if (localStorage.getItem('cart') !== null) {
              cartItems = new Map(JSON.parse(localStorage.getItem('cart')));
              // cartItems = [jsonArr.length];
              //
              // for(let i = 0; i < jsonArr.length; i++) {
              //     cartItems[i] = CartItem.FromJsonObj(jsonArr[i]);
              // }
          }
      }

      function saveCart() {
          let jsonCart = JSON.stringify(Array.from(cartItems.entries()));
          console.debug('saving cart');
          console.debug(jsonCart);
          localStorage.setItem('cart', JSON.stringify(cartItems));
      }


      function deleteCartItem(merchID) {
          for(let i = 0; i < cartItems.length; i++) {
              if (cartItems[i].merchID === merchID) {
                  cartItems.splice(i, 1);
                  i--;
              }
          }
          saveCart();
          displayCartItems();
      }

      function updateCartQuantity(sel, merchID) {
          for (let i = 0; i < cartItems.length; i++) {
              if (cartItems[i].merchID === merchID) {
                  cartItems[i].quantity = Number.parseInt(sel.value);
              }
          }
          saveCart();
          displayCartItems();
      }
  </script>
</head>

<body onload="onLoad()">
<div class="cover-container d-flex h-100 mx-auto flex-column">
  <!--header-->
  <div class="jumbotron header">
    <div class="container">
      <div class="row">
        <div class="col-lg-4 col-md-5 col-sm-6 col-12 my-auto mb-4">
          <div class="media align-items-center">
            <img class="img-fluid" src="./img/logo.png" style="max-width:120px" alt="Pet Store Logo">
            <div class="media-body">
              <h2 class="header__title">Pet Store</h2>
            </div>
          </div>
        </div>
        <div class="col-lg-4 offset-lg-4 col-md-5 col-sm-6 offset-md-2 col-12 my-auto mb-4">
          <p class="text-right">
            <i class="fas fa-phone body__icon"></i>456-678-1232
            <i class="fas fa-user-circle body__icon body_icon--right"></i>
            <span id="status"></span>
          </p>
        </div>
      </div>
    </div>
  </div>
  <!--end header-->

  <!--navbar-->
  <nav class="navbar navbar-expand-sm navbar-dark navbar-toggleable menu">
    <div class="container">
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#collapsibleNavbar">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="collapsibleNavbar">
        <ul class="nav navbar-nav">
          <li class="nav-item menu__item text-uppercase"><a class="nav-link" href="./index.html">Home</a></li>
          <li class="nav-item menu__item text-uppercase"><a class="nav-link" href="./index.html?category=cats">Cats</a></li>
          <li class="nav-item menu__item text-uppercase"><a class="nav-link" href="./index.html?category=dogs">Dogs</a></li>
          <li class="nav-item menu__item text-uppercase"><a class="nav-link" href="./index.html?category=fish">Fish</a></li>
          <li class="nav-item menu__item text-uppercase"><a class="nav-link" href="./index.html?category=birds">Birds</a></li>
        </ul>
      </div>
      <div class="navbar-text menu__icon" id="cart_button"></div>
    </div>
  </nav>
  <!--navbar end-->

  <!--Hello-->
  <div class="container">
    <h5 class="middle-weight-heading pt-3" id="hello"></h5>
  </div>
  <!--/end Hello-->

  <section id="customer_home_page">
    <div class="container">
      <div class="row">
        <!--Cart-->
        <div class="col-lg-8 col-12 px-5 cart__row">
          <h5 class="middle-weight-heading pt-4 pl-5" id="cart_title">Review Items in your Cart:</h5>
          <div class="table-responsive pt-2" id="cart_container">

          </div>
          <div class="cart__subtotal" id="cart_subtotal">

          </div>
          <div class="buttons px-3">
            <div>
              <button type="button" class="btn btn-custom right-item my-3 middle-weight-heading">
                <a href="./index.html">Continue Shopping</a>
              </button>
            </div>
          </div>
        </div>
        <!--Customer's Data-->
        <div class="col-lg-4 col-12">
          <h5 class="middle-weight-heading pt-4 pl-5">Your Shipment Address:</h5>
          <div class="mx-auto login pt-2">
            <div class="login__inner">
              <div id="customer-data" class="p-3">
                <p class="text-uppercase p-customer" id="customer_name"></p>
                <p class="text-uppercase heavy-weight-heading p-customer" id="street_address"></p>
                <p class="text-uppercase heavy-weight-heading p-customer" id="city_state"></p>
              </div>
            </div>
          </div>
          <h5 class="middle-weight-heading pt-4 pl-5">Your Payment Method:</h5>
          <div class="mx-auto login my-auto" style="padding-top:10px; max-width:300px;">
            <div class="login__inner">
              <div id="payment-data" class="text-center align-middle">
                <p>xxxx xxxx xxxx 5678</p>
              </div>
            </div>
          </div>
          <div class="buttons pt-3 px-3">
            <div style="">
              <button type="button" class="btn btn-custom left-item heavy-weight-heading mt-2 mb-3">Submit the
                Order
              </button>
            </div>
            <div style="">
              <button type="button" class="btn btn-custom right-item middle-weight-heading mt-2 mb-3"
                      onclick="document.location.assign('customer.html');">Change Data
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!--footer-->
  <footer class="footer mastfoot mt-auto footer-custom">
    <div class="container">
      <div class="row">
        <div class="col-lg-3 col-md-6 col-6 text-center">
          <p class="text-uppercase footer__title">Contact us</p>
          <p class="footer__text">Email: shop@pet-sup.com</p>
          <p>Phone: 456-678-1232</p>
        </div>
        <div class="col-lg-3 offset-lg-6 col-md-3 offset-md-3 col-6 text-center">
          <div class="">
            <p class="text-uppercase footer__title">Follow us</p>
            <i class="fab fa-facebook-square body__icon"></i>
            <i class="fab fa-twitter-square body__icon"></i>
            <i class="fab fa-instagram body__icon"></i>
          </div>
        </div>
      </div>
    </div>
  </footer>
</div>
</body>
</html>
